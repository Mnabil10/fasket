generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ADMIN
  STAFF
  PROVIDER
  DRIVER
}

enum ProductStatus {
  DRAFT
  ACTIVE
  HIDDEN
  DISCONTINUED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERY_FAILED
  DELIVERED
  CANCELED
}

enum PaymentMethod {
  COD
  CARD
  WALLET
}

enum WalletProvider {
  VODAFONE_CASH
  ORANGE_MONEY
  ETISALAT_CASH
}

enum ProviderType {
  SUPERMARKET
  PHARMACY
  RESTAURANT
  SERVICE
  OTHER
}

enum ProviderStatus {
  PENDING
  ACTIVE
  REJECTED
  SUSPENDED
  DISABLED
}

enum BranchStatus {
  ACTIVE
  INACTIVE
}

enum DeliveryMode {
  PLATFORM
  MERCHANT
}

enum ProductOptionGroupType {
  SINGLE
  MULTI
}

enum ProductOptionGroupPriceMode {
  ADD
  SET
}

enum DeliveryFailureReason {
  NO_ANSWER
  WRONG_ADDRESS
  UNSAFE_LOCATION
  CUSTOMER_REQUESTED_RESCHEDULE
}

enum ProviderUserRole {
  OWNER
  MANAGER
  STAFF
}

enum ProviderApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderGroupStatus {
  PENDING
  PAID
  CANCELED
}

enum OrderSplitFailurePolicy {
  CANCEL_GROUP
  PARTIAL
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
}

enum InvoiceItemType {
  SUBSCRIPTION
  COMMISSION
  ADJUSTMENT
}

enum CouponScope {
  PLATFORM
  PROVIDER
  BRANCH
}

enum LoyaltyTransactionType {
  EARN
  REDEEM
  ADJUST
}

enum AutomationEventStatus {
  PENDING
  SENT
  FAILED
  DEAD
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENT
  CANCELED
}

enum CampaignChannel {
  PUSH
  SMS
  WHATSAPP
  EMAIL
}

enum SupportChannel {
  WHATSAPP
}

enum SupportConversationStatus {
  OPEN
  PENDING
  RESOLVED
}

enum SupportMessageDirection {
  INBOUND
  OUTBOUND
}

enum SupportMessageType {
  TEXT
  TEMPLATE
  DOCUMENT
}

enum WhatsAppProvider {
  MOCK
  META
}

enum WhatsAppMessageDirection {
  INBOUND
  OUTBOUND
}

enum WhatsAppMessageStatus {
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
  RECEIVED
}

enum WhatsAppMessageType {
  TEXT
  TEMPLATE
  DOCUMENT
}

enum TelegramLinkStatus {
  linked
  blocked
  unlinked
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CommissionMode {
  SUBSCRIPTION_ONLY
  COMMISSION_ONLY
  HYBRID
}

enum CommissionScope {
  PLATFORM
  PROVIDER
  CATEGORY
  PROVIDER_CATEGORY
}

enum CommissionDiscountRule {
  BEFORE_DISCOUNT
  AFTER_DISCOUNT
}

enum FeeRecipient {
  PLATFORM
  VENDOR
}

enum LedgerEntryType {
  ORDER_SETTLEMENT
  HOLD_RELEASE
  PAYOUT
  PAYOUT_FEE
  PAYOUT_REVERSAL
  ADJUSTMENT
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

model User {
  id                           String                      @id @default(cuid())
  email                        String?                     @unique
  phone                        String                      @unique
  password                     String
  role                         UserRole                    @default(CUSTOMER)
  name                         String
  loyaltyPoints                Int                         @default(0)
  twoFaEnabled                 Boolean                     @default(false)
  twoFaSecret                  String?
  addresses                    Address[]
  paymentMethods               SavedPaymentMethod[]
  cart                         Cart?
  orders                       Order[]
  loyaltyTransactions          LoyaltyTransaction[]
  loyaltyCycles                LoyaltyCycle[]
  sessions                     SessionLog[]
  pushDevices                  PushDevice[]
  telegramLink                 TelegramLink?
  providerMemberships          ProviderUser[]
  notificationPreference       UserNotificationPreference?
  orderGroups                  OrderGroup[]
  reviews                      Review[]
  reviewReplies                Review[]                    @relation("ReviewReplyBy")
  supportConversations         SupportConversation[]
  supportConversationsAssigned SupportConversation[]       @relation("SupportConversationAssigned")
  supportMessages              SupportMessage[]            @relation("SupportMessageAgent")
  driverProfile                DeliveryDriver?
  payoutsRequested             Payout[]                    @relation("PayoutRequestedBy")
  payoutsProcessed             Payout[]                    @relation("PayoutProcessedBy")
  createdAt                    DateTime                    @default(now())
  updatedAt                    DateTime                    @updatedAt
}

model Address {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  zoneId      String
  label       String?
  city        String?
  street      String?
  building    String?
  apartment   String?
  notes       String?
  lat         Float?
  lng         Float?
  isDefault   Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  orders      Order[]
  orderGroups OrderGroup[]

  @@index([zoneId])
}

model SavedPaymentMethod {
  id             String          @id @default(cuid())
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  type           PaymentMethod
  provider       String?
  token          String
  last4          String?
  brand          String?
  expMonth       Int?
  expYear        Int?
  walletProvider WalletProvider?
  walletPhone    String?
  isDefault      Boolean         @default(false)
  metadata       Json?
  orderGroups    OrderGroup[]
  orders         Order[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
  @@index([type])
}

model Provider {
  id                     String         @id @default(cuid())
  name                   String
  nameAr                 String?
  slug                   String         @unique
  type                   ProviderType   @default(SUPERMARKET)
  status                 ProviderStatus @default(PENDING)
  deliveryMode           DeliveryMode   @default(PLATFORM)
  ratingAvg              Float          @default(0)
  ratingCount            Int            @default(0)
  deliveryRatePerKmCents Int?
  minDeliveryFeeCents    Int?
  maxDeliveryFeeCents    Int?
  contactEmail           String?
  contactPhone           String?
  logoUrl                String?
  description            String?
  descriptionAr          String?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt

  branches               Branch[]
  products               Product[]
  categories             Category[]
  coupons                Coupon[]
  orders                 Order[]
  memberships            ProviderUser[]
  subscriptions          ProviderSubscription[]
  invoices               Invoice[]
  ledgerEntries          ProviderLedger[]
  commissionConfigs      CommissionConfig[]
  balance                VendorBalance?
  payouts                Payout[]
  financials             OrderFinancials[]
  transactionLedger      TransactionLedger[]
  notificationPreference ProviderNotificationPreference?
  deliveryZones          DeliveryZone[]
  deliveryWindows        DeliveryWindow[]
  deliveryZonePricings   ProviderDeliveryZonePricing[]
  reviews                Review[]
  applications           ProviderApplication[]
}

model ProviderApplication {
  id              String                    @id @default(cuid())
  businessName    String
  providerType    ProviderType
  city            String?
  region          String?
  ownerName       String
  phone           String
  email           String?
  deliveryMode    DeliveryMode              @default(PLATFORM)
  notes           String?
  status          ProviderApplicationStatus @default(PENDING)
  rejectionReason String?
  providerId      String?
  provider        Provider?                 @relation(fields: [providerId], references: [id])
  reviewedAt      DateTime?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@index([status])
  @@index([providerType])
  @@index([city])
  @@index([providerId])
}

model Branch {
  id                     String        @id @default(cuid())
  providerId             String
  provider               Provider      @relation(fields: [providerId], references: [id])
  name                   String
  nameAr                 String?
  slug                   String        @unique
  status                 BranchStatus  @default(ACTIVE)
  address                String?
  city                   String?
  region                 String?
  lat                    Float?
  lng                    Float?
  deliveryMode           DeliveryMode?
  deliveryRadiusKm       Float?
  deliveryRatePerKmCents Int?
  minDeliveryFeeCents    Int?
  maxDeliveryFeeCents    Int?
  schedulingEnabled      Boolean       @default(false)
  schedulingAllowAsap    Boolean       @default(true)
  serviceArea            Json? // GeoJSON or polygon payload
  isDefault              Boolean       @default(false)
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  branchProducts  BranchProduct[]
  orders          Order[]
  coupons         Coupon[]
  deliveryZones   DeliveryZone[]
  deliveryWindows DeliveryWindow[]
  cartItems       CartItem[]

  @@index([providerId])
  @@index([status])
}

model ProviderUser {
  id         String           @id @default(cuid())
  providerId String
  userId     String
  role       ProviderUserRole @default(STAFF)
  createdAt  DateTime         @default(now())

  provider Provider @relation(fields: [providerId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([providerId, userId])
  @@index([userId])
}

model Category {
  id                String             @id @default(cuid())
  providerId        String?
  provider          Provider?          @relation(fields: [providerId], references: [id])
  name              String
  nameAr            String?
  slug              String             @unique
  imageUrl          String?
  isActive          Boolean            @default(true)
  sortOrder         Int                @default(0)
  products          Product[]
  commissionConfigs CommissionConfig[]
  parentId          String?
  parent            Category?          @relation("CategoryToCategory", fields: [parentId], references: [id])
  children          Category[]         @relation("CategoryToCategory")
  deletedAt         DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([parentId])
  @@index([isActive, sortOrder])
  @@index([providerId])
}

model Product {
  id             String               @id @default(cuid())
  providerId     String?
  provider       Provider?            @relation(fields: [providerId], references: [id])
  categoryId     String?
  category       Category?            @relation(fields: [categoryId], references: [id])
  sku            String?              @unique
  name           String
  nameAr         String?
  slug           String               @unique
  description    String?
  descriptionAr  String?
  imageUrl       String?
  priceCents     Int
  costPriceCents Int?                 @default(0)
  salePriceCents Int?
  stock          Int                  @default(0)
  status         ProductStatus        @default(ACTIVE)
  isHotOffer     Boolean              @default(false)
  images         String[]
  cartItems      CartItem[]
  orderItems     OrderItem[]
  optionGroups   ProductOptionGroup[] @relation("ProductOptionGroups")
  stockLogs      ProductStockLog[]
  branchProducts BranchProduct[]
  deletedAt      DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@index([name])
  @@index([slug])
  @@index([categoryId, status])
  @@index([isHotOffer, status, createdAt])
  @@index([status, createdAt])
  @@index([providerId])
}

model ProductOptionGroup {
  id          String                      @id @default(cuid())
  name        String
  nameAr      String?
  type        ProductOptionGroupType
  priceMode   ProductOptionGroupPriceMode @default(ADD)
  minSelected Int                         @default(0)
  maxSelected Int?
  sortOrder   Int                         @default(0)
  isActive    Boolean                     @default(true)
  products    Product[]                   @relation("ProductOptionGroups")
  options     ProductOption[]
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt

  @@index([isActive, sortOrder])
}

model ProductOption {
  id              String             @id @default(cuid())
  groupId         String
  group           ProductOptionGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name            String
  nameAr          String?
  priceCents      Int                @default(0)
  maxQtyPerOption Int?
  sortOrder       Int                @default(0)
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  cartItemOptions  CartItemOption[]
  orderItemOptions OrderItemOption[]

  @@index([groupId])
  @@index([isActive, sortOrder])
}

model BranchProduct {
  id             String   @id @default(cuid())
  branchId       String
  productId      String
  priceCents     Int?
  salePriceCents Int?
  stock          Int?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  branch  Branch  @relation(fields: [branchId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([branchId, productId])
  @@index([branchId])
  @@index([productId])
}

model Cart {
  id         String     @id @default(cuid())
  userId     String     @unique
  user       User       @relation(fields: [userId], references: [id])
  items      CartItem[]
  orders     Order[]
  couponCode String?
  updatedAt  DateTime   @updatedAt
  createdAt  DateTime   @default(now())
}

model CartItem {
  id          String  @id @default(cuid())
  cartId      String
  productId   String
  branchId    String?
  qty         Int     @default(1)
  priceCents  Int
  optionsHash String  @default("")

  cart    Cart             @relation(fields: [cartId], references: [id])
  product Product          @relation(fields: [productId], references: [id])
  branch  Branch?          @relation(fields: [branchId], references: [id])
  options CartItemOption[]

  @@unique([cartId, productId, branchId, optionsHash])
  @@index([branchId])
}

model CartItemOption {
  id         String   @id @default(cuid())
  cartItemId String
  optionId   String
  qty        Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  cartItem CartItem      @relation(fields: [cartItemId], references: [id], onDelete: Cascade)
  option   ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([cartItemId, optionId])
  @@index([cartItemId])
}

model OrderGroup {
  id                    String                  @id @default(cuid())
  code                  String                  @unique @default(cuid())
  userId                String?
  user                  User?                   @relation(fields: [userId], references: [id])
  idempotencyKey        String?
  addressId             String?
  address               Address?                @relation(fields: [addressId], references: [id])
  guestName             String?
  guestPhone            String?
  guestAddress          Json?
  guestLat              Float?
  guestLng              Float?
  status                OrderGroupStatus        @default(PENDING)
  splitFailurePolicy    OrderSplitFailurePolicy @default(PARTIAL)
  paymentMethod         PaymentMethod           @default(COD)
  paymentMethodId       String?
  paymentMethodRef      SavedPaymentMethod?     @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)
  deliveryTermsAccepted Boolean?
  deliveryWindowId      String?
  deliveryWindow        DeliveryWindow?         @relation(fields: [deliveryWindowId], references: [id])
  scheduledAt           DateTime?
  couponCode            String?
  subtotalCents         Int
  shippingFeeCents      Int                     @default(0)
  serviceFeeCents       Int?
  discountCents         Int                     @default(0)
  totalCents            Int
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  orders        Order[]
  ledgerEntries ProviderLedger[]

  @@unique([userId, idempotencyKey])
  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model Order {
  id                     String                   @id @default(cuid())
  code                   String                   @unique @default(cuid())
  userId                 String?
  user                   User?                    @relation(fields: [userId], references: [id])
  idempotencyKey         String?
  cartId                 String?
  cart                   Cart?                    @relation(fields: [cartId], references: [id])
  orderGroupId           String?
  orderGroup             OrderGroup?              @relation(fields: [orderGroupId], references: [id])
  providerId             String?
  provider               Provider?                @relation(fields: [providerId], references: [id])
  branchId               String?
  branch                 Branch?                  @relation(fields: [branchId], references: [id])
  addressId              String?
  address                Address?                 @relation(fields: [addressId], references: [id])
  guestName              String?
  guestPhone             String?
  guestAddress           Json?
  guestLat               Float?
  guestLng               Float?
  deliveryZoneId         String?
  deliveryZoneName       String?
  deliveryEtaMinutes     Int?
  estimatedDeliveryTime  String?
  deliveryMode           DeliveryMode             @default(PLATFORM)
  deliveryDistanceKm     Float?
  deliveryRatePerKmCents Int?
  notes                  String?
  couponCode             String?
  deliveryTermsAccepted  Boolean?
  subtotalCents          Int
  shippingFeeCents       Int                      @default(0)
  serviceFeeCents        Int?
  discountCents          Int                      @default(0)
  loyaltyDiscountCents   Int                      @default(0)
  loyaltyPointsUsed      Int                      @default(0)
  loyaltyPointsEarned    Int                      @default(0)
  totalCents             Int
  status                 OrderStatus              @default(PENDING)
  outForDeliveryAt       DateTime?
  deliveredAt            DateTime?
  deliveryFailedAt       DateTime?
  deliveryFailedReason   DeliveryFailureReason?
  deliveryFailedNote     String?
  paymentMethod          PaymentMethod            @default(COD)
  paymentMethodId        String?
  paymentMethodRef       SavedPaymentMethod?      @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)
  deliveryWindowId       String?
  deliveryWindow         DeliveryWindow?          @relation(fields: [deliveryWindowId], references: [id])
  scheduledAt            DateTime?
  driverId               String?
  driver                 DeliveryDriver?          @relation(fields: [driverId], references: [id], onDelete: SetNull)
  driverAssignedAt       DateTime?
  items                  OrderItem[]
  statusHistory          OrderStatusHistory[]
  driverLocations        DeliveryDriverLocation[]
  loyaltyTransactions    LoyaltyTransaction[]
  ledgerEntries          ProviderLedger[]
  financials             OrderFinancials?
  transactionLedger      TransactionLedger[]
  reviews                Review[]
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt

  @@unique([userId, idempotencyKey])
  @@index([status, createdAt])
  @@index([userId, createdAt])
  @@index([driverId])
  @@index([driverId, createdAt])
  @@index([orderGroupId])
  @@index([providerId])
  @@index([branchId])
  @@index([code])
  @@index([createdAt])
}

model OrderItem {
  id                  String @id @default(cuid())
  orderId             String
  productId           String
  productNameSnapshot String
  priceSnapshotCents  Int
  unitPriceCents      Int    @default(0)
  unitCostCents       Int    @default(0)
  lineTotalCents      Int    @default(0)
  lineProfitCents     Int    @default(0)
  qty                 Int

  order   Order             @relation(fields: [orderId], references: [id])
  product Product           @relation(fields: [productId], references: [id])
  options OrderItemOption[]

  @@index([productId])
  @@index([orderId])
}

model OrderItemOption {
  id                   String   @id @default(cuid())
  orderItemId          String
  optionId             String?
  optionNameSnapshot   String
  optionNameArSnapshot String?
  priceSnapshotCents   Int
  qty                  Int      @default(1)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  orderItem OrderItem      @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  option    ProductOption? @relation(fields: [optionId], references: [id], onDelete: SetNull)

  @@index([orderItemId])
}

model Review {
  id             String       @id @default(cuid())
  providerId     String
  userId         String
  orderId        String
  rating         Int
  comment        String?
  status         ReviewStatus @default(PENDING)
  moderatedById  String?
  moderatedAt    DateTime?
  moderationNote String?
  reply          String?
  replyAt        DateTime?
  replyById      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  replyBy  User?    @relation("ReviewReplyBy", fields: [replyById], references: [id])

  @@unique([orderId, userId])
  @@index([providerId, status, createdAt])
  @@index([userId, createdAt])
}

model SupportQueryAudit {
  id              String   @id @default(cuid())
  endpoint        String
  phoneHash       String?
  phoneMasked     String?
  orderCode       String?
  success         Boolean  @default(false)
  correlationId   String?
  ip              String?
  responseSnippet String?
  createdAt       DateTime @default(now())

  @@index([endpoint, createdAt])
}

model SupportConversation {
  id                 String                    @id @default(cuid())
  channel            SupportChannel
  status             SupportConversationStatus @default(OPEN)
  phone              String
  userId             String?
  assignedToId       String?
  lastMessageAt      DateTime?
  lastMessagePreview String?
  metadata           Json?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt

  user         User?                @relation(fields: [userId], references: [id])
  assignedTo   User?                @relation("SupportConversationAssigned", fields: [assignedToId], references: [id])
  messages     SupportMessage[]
  whatsappLogs WhatsAppMessageLog[]

  @@unique([channel, phone])
  @@index([status, updatedAt])
  @@index([phone])
  @@index([userId])
  @@index([assignedToId])
}

model SupportMessage {
  id             String                  @id @default(cuid())
  conversationId String
  direction      SupportMessageDirection
  messageType    SupportMessageType
  body           String?
  externalId     String?
  metadata       Json?
  agentId        String?
  createdAt      DateTime                @default(now())

  conversation SupportConversation  @relation(fields: [conversationId], references: [id])
  agent        User?                @relation("SupportMessageAgent", fields: [agentId], references: [id])
  whatsappLogs WhatsAppMessageLog[]

  @@index([conversationId, createdAt])
  @@index([externalId])
}

model WhatsAppMessageLog {
  id                    String                   @id @default(cuid())
  provider              WhatsAppProvider
  direction             WhatsAppMessageDirection
  type                  WhatsAppMessageType
  status                WhatsAppMessageStatus
  toPhone               String?
  fromPhone             String?
  templateName          String?
  templateLanguage      String?                  @db.VarChar(8)
  body                  String?
  mediaUrl              String?
  providerMessageId     String?                  @unique
  supportConversationId String?
  supportMessageId      String?
  errorCode             String?
  errorMessage          String?
  payload               Json?
  attempts              Int                      @default(0)
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt

  supportConversation SupportConversation? @relation(fields: [supportConversationId], references: [id])
  supportMessage      SupportMessage?      @relation(fields: [supportMessageId], references: [id])

  @@index([status, updatedAt])
  @@index([supportConversationId])
  @@index([supportMessageId])
}

model OrderStatusHistory {
  id        String       @id @default(cuid())
  orderId   String
  order     Order        @relation(fields: [orderId], references: [id])
  from      OrderStatus?
  to        OrderStatus
  note      String?
  actorId   String?
  createdAt DateTime     @default(now())
}

model DeliveryDriver {
  id                 String   @id @default(cuid())
  userId             String?  @unique
  fullName           String
  phone              String   @unique
  nationalId         String   @unique
  nationalIdImageUrl String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user      User?                    @relation(fields: [userId], references: [id])
  vehicle   DeliveryVehicle?
  orders    Order[]
  locations DeliveryDriverLocation[]

  @@index([userId])
  @@index([isActive, createdAt])
  @@index([isActive])
  @@index([fullName])
  @@index([phone])
  @@index([nationalId])
  @@index([createdAt])
}

model DeliveryVehicle {
  id              String         @id @default(cuid())
  driverId        String         @unique
  driver          DeliveryDriver @relation(fields: [driverId], references: [id])
  type            String
  plateNumber     String         @unique
  licenseImageUrl String?
  color           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([plateNumber])
}

model DeliveryDriverLocation {
  id         String         @id @default(cuid())
  driverId   String
  driver     DeliveryDriver @relation(fields: [driverId], references: [id], onDelete: Cascade)
  orderId    String?
  order      Order?         @relation(fields: [orderId], references: [id], onDelete: SetNull)
  lat        Float
  lng        Float
  accuracy   Float?
  heading    Float?
  speed      Float?
  recordedAt DateTime       @default(now())

  @@index([driverId, recordedAt])
  @@index([orderId, recordedAt])
}

model DeliveryWindow {
  id                  String   @id @default(cuid())
  providerId          String
  branchId            String?
  name                String
  nameAr              String?
  startMinutes        Int
  endMinutes          Int
  daysOfWeek          Int[]
  minLeadMinutes      Int?
  minOrderAmountCents Int?
  isActive            Boolean  @default(true)
  sortOrder           Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  provider    Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  branch      Branch?      @relation(fields: [branchId], references: [id], onDelete: Cascade)
  orders      Order[]
  orderGroups OrderGroup[]

  @@index([providerId])
  @@index([branchId])
  @@index([isActive, sortOrder])
}

model DeliveryZone {
  id                         String   @id @default(cuid())
  providerId                 String?
  branchId                   String?
  nameEn                     String
  nameAr                     String?
  city                       String?
  region                     String?
  feeCents                   Int
  etaMinutes                 Int?
  freeDeliveryThresholdCents Int?
  minOrderAmountCents        Int?
  isActive                   Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  provider         Provider?                     @relation(fields: [providerId], references: [id])
  branch           Branch?                       @relation(fields: [branchId], references: [id])
  providerPricings ProviderDeliveryZonePricing[]

  @@index([isActive, nameEn])
  @@index([city])
  @@index([region])
  @@index([isActive, city, region])
  @@index([providerId])
  @@index([branchId])
}

model ProviderDeliveryZonePricing {
  id         String   @id @default(cuid())
  providerId String
  zoneId     String
  feeCents   Int
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  provider Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  zone     DeliveryZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([providerId, zoneId])
  @@index([providerId])
  @@index([zoneId])
}

model LoyaltyCycle {
  id              String               @id @default(cuid())
  userId          String
  user            User                 @relation(fields: [userId], references: [id])
  startedAt       DateTime             @default(now())
  completedAt     DateTime?
  threshold       Int
  resetOnComplete Boolean              @default(true)
  earnedInCycle   Int                  @default(0)
  transactions    LoyaltyTransaction[]

  @@index([userId, completedAt])
}

model LoyaltyTransaction {
  id        String                 @id @default(cuid())
  userId    String
  user      User                   @relation(fields: [userId], references: [id])
  orderId   String?
  order     Order?                 @relation(fields: [orderId], references: [id])
  type      LoyaltyTransactionType
  points    Int
  metadata  Json?
  cycleId   String?
  cycle     LoyaltyCycle?          @relation(fields: [cycleId], references: [id])
  createdAt DateTime               @default(now())

  @@index([userId, createdAt])
  @@index([orderId])
  @@index([cycleId])
  @@index([userId, type, createdAt])
}

model NotificationTemplate {
  id        String   @id @default(cuid())
  key       String
  language  String   @db.VarChar(8)
  title     String?
  body      String
  channel   String   @default("push")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, language, channel])
}

model ProductStockLog {
  id            String   @id @default(cuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  previousStock Int
  newStock      Int
  delta         Int
  reason        String
  actorId       String?
  createdAt     DateTime @default(now())

  @@index([productId, createdAt])
}

model AuditLog {
  id            String   @id @default(cuid())
  actorId       String?
  action        String
  entity        String
  entityId      String?
  before        Json?
  after         Json?
  ip            String?
  userAgent     String?
  correlationId String?
  createdAt     DateTime @default(now())

  @@index([entity, entityId])
  @@index([actorId, createdAt])
}

model SessionLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  ip        String?
  userAgent String?
  device    Json?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model AutomationEvent {
  id                      String                @id @default(uuid())
  type                    String
  payload                 Json
  status                  AutomationEventStatus @default(PENDING)
  attempts                Int                   @default(0)
  nextAttemptAt           DateTime?
  dedupeKey               String?
  correlationId           String?
  lastHttpStatus          Int?
  lastError               String?
  lastResponseAt          DateTime?
  lastResponseBodySnippet String?
  sentAt                  DateTime?
  createdAt               DateTime              @default(now())

  @@unique([type, dedupeKey])
  @@index([status, nextAttemptAt])
  @@index([dedupeKey])
  @@index([type])
  @@index([createdAt])
}

model MarketingCampaign {
  id          String          @id @default(cuid())
  name        String
  title       String?
  message     String
  channel     CampaignChannel @default(PUSH)
  status      CampaignStatus  @default(DRAFT)
  segment     Json?
  payload     Json?
  scheduledAt DateTime?
  sentAt      DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([status, scheduledAt])
  @@index([channel])
}

// prisma/schema.prisma  (only the Setting model shown)
model Setting {
  id String @id @default(cuid())

  // General
  storeName          String  @default("Fasket")
  storeNameAr        String?
  storeDescription   String? // long text
  storeDescriptionAr String?
  contactEmail       String? // e.g. support@fasket.com
  contactPhone       String?
  storeAddress       String?
  businessHours      Json? // { monday:{open,close,enabled}, ... }

  // Delivery
  deliveryFeeCents         Int     @default(0) // e.g. 499 for 4.99
  freeDeliveryMinimumCents Int     @default(0)
  estimatedDeliveryTime    String? // "25-30 minutes"
  maxDeliveryRadiusKm      Int? // 10
  deliveryRatePerKmCents   Int? // distance-based fee per km (cents)
  minDeliveryFeeCents      Int?
  maxDeliveryFeeCents      Int?
  deliveryZones            Json? // [{name, fee, enabled}, ...]

  // Payment (JSON for flexibility)
  payment Json? // { cashOnDelivery, creditCards, digitalWallets, stripe }

  // Notifications
  notifications Json? // { orderNotifications, marketingEmails, adminAlerts }

  // Mobile app
  mobileAppConfig Json? // dynamic mobile app configuration payload

  // Loyalty
  loyaltyEnabled            Boolean @default(false)
  loyaltyEarnPoints         Int     @default(1) // points granted per earn unit
  loyaltyEarnPerCents       Int     @default(100) // cents needed to earn loyaltyEarnPoints
  loyaltyRedeemRate         Int     @default(100) // points required per redeem unit
  loyaltyRedeemUnitCents    Int     @default(100) // value in cents of one redeem unit
  loyaltyMinRedeemPoints    Int     @default(0)
  loyaltyMaxDiscountPercent Int     @default(100)
  loyaltyMaxRedeemPerOrder  Int     @default(0)
  loyaltyResetThreshold     Int     @default(0)
  loyaltyEarnRate           Float?
  loyaltyRedeemRateValue    Float?

  // System
  maintenanceMode          Boolean @default(false)
  allowRegistrations       Boolean @default(true)
  requireEmailVerification Boolean @default(true)
  sessionTimeoutMinutes    Int     @default(30)
  maxLoginAttempts         Int     @default(5)
  dataRetentionDays        Int     @default(365)
  backupFrequency          String  @default("daily") // daily|weekly|monthly
  timezone                 String  @default("America/New_York")
  language                 String  @default("en")
  currency                 String  @default("EGP")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TelegramLink {
  id               Int                @id @default(autoincrement()) @map("id")
  userId           String             @unique @map("user_id")
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  phoneE164        String             @unique @map("phone_e164")
  telegramChatId   BigInt             @unique @map("telegram_chat_id")
  telegramUserId   BigInt?            @map("telegram_user_id")
  telegramUsername String?            @map("telegram_username")
  status           TelegramLinkStatus @default(linked)
  linkedAt         DateTime?          @map("linked_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  createdAt        DateTime           @default(now()) @map("created_at")
  lastOtpSentAt    DateTime?          @map("last_otp_sent_at")
  lastOtpAttempts  Int                @default(0) @map("last_otp_attempts")

  @@index([status])
  @@index([lastOtpSentAt])
  @@map("telegram_links")
}

model SignupLink {
  sessionKey       String    @id @map("session_key")
  telegramChatId   BigInt    @map("telegram_chat_id")
  telegramUserId   BigInt?   @map("telegram_user_id")
  telegramUsername String?   @map("telegram_username")
  createdAt        DateTime  @default(now()) @map("created_at")
  expiresAt        DateTime  @map("expires_at")
  otpHash          String?   @map("otp_hash")
  otpExpiresAt     DateTime? @map("otp_expires_at")
  otpAttempts      Int       @default(0) @map("otp_attempts")
  requestId        String?   @map("request_id")

  @@index([expiresAt])
  @@map("signup_links")
}

model SignupSession {
  id               String    @id @map("id")
  phone            String    @map("phone")
  country          String    @map("country")
  fullName         String?   @map("full_name")
  status           String    @default("PENDING_TELEGRAM") @map("status")
  telegramChatId   BigInt?   @map("telegram_chat_id")
  telegramUserId   BigInt?   @map("telegram_user_id")
  telegramUsername String?   @map("telegram_username")
  otpHash          String?   @map("otp_hash")
  otpExpiresAt     DateTime? @map("otp_expires_at")
  otpAttempts      Int       @default(0) @map("otp_attempts")
  requestId        String?   @map("request_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  expiresAt        DateTime  @map("expires_at")

  @@index([status])
  @@index([expiresAt])
  @@map("signup_sessions")
}

enum CouponType {
  PERCENT
  FIXED
}

model Coupon {
  id               String      @id @default(cuid())
  code             String      @unique
  scope            CouponScope @default(PLATFORM)
  providerId       String?
  branchId         String?
  type             CouponType
  valueCents       Int // For FIXED: amount in cents; For PERCENT: percentage value (0-100)
  isPercent        Boolean     @default(false) // legacy helper, not required
  isActive         Boolean     @default(true)
  startsAt         DateTime?
  endsAt           DateTime?
  minOrderCents    Int?
  maxDiscountCents Int?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  provider Provider? @relation(fields: [providerId], references: [id])
  branch   Branch?   @relation(fields: [branchId], references: [id])

  @@index([providerId])
  @@index([branchId])
}

model PushDevice {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  platform     String   @default("unknown")
  language     String?  @db.VarChar(8)
  appVersion   String?
  deviceModel  String?
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Plan {
  id                String          @id @default(cuid())
  code              String          @unique
  name              String
  description       String?
  billingInterval   BillingInterval
  amountCents       Int             @default(0)
  currency          String          @default("EGP")
  commissionRateBps Int             @default(0) // 100 = 1%
  trialDays         Int             @default(0)
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  subscriptions ProviderSubscription[]
}

model ProviderSubscription {
  id                        String             @id @default(cuid())
  providerId                String
  planId                    String
  status                    SubscriptionStatus @default(TRIALING)
  commissionRateBpsOverride Int?
  currentPeriodStart        DateTime?
  currentPeriodEnd          DateTime?
  trialEndsAt               DateTime?
  cancelAt                  DateTime?
  canceledAt                DateTime?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt

  provider Provider  @relation(fields: [providerId], references: [id])
  plan     Plan      @relation(fields: [planId], references: [id])
  invoices Invoice[]

  @@index([providerId, status])
  @@index([planId])
}

model Invoice {
  id              String        @id @default(cuid())
  providerId      String
  subscriptionId  String?
  number          String        @unique
  status          InvoiceStatus @default(DRAFT)
  currency        String        @default("EGP")
  amountDueCents  Int           @default(0)
  amountPaidCents Int           @default(0)
  dueAt           DateTime?
  paidAt          DateTime?
  periodStart     DateTime?
  periodEnd       DateTime?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  provider      Provider              @relation(fields: [providerId], references: [id])
  subscription  ProviderSubscription? @relation(fields: [subscriptionId], references: [id])
  items         InvoiceItem[]
  ledgerEntries ProviderLedger[]

  @@index([providerId, createdAt])
  @@index([subscriptionId])
}

model InvoiceItem {
  id          String          @id @default(cuid())
  invoiceId   String
  type        InvoiceItemType
  description String?
  amountCents Int
  metadata    Json?
  createdAt   DateTime        @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
}

model ProviderLedger {
  id           String          @id @default(cuid())
  providerId   String
  orderId      String?
  orderGroupId String?
  invoiceId    String?
  type         InvoiceItemType
  amountCents  Int
  currency     String          @default("EGP")
  metadata     Json?
  createdAt    DateTime        @default(now())

  provider   Provider    @relation(fields: [providerId], references: [id])
  order      Order?      @relation(fields: [orderId], references: [id])
  orderGroup OrderGroup? @relation(fields: [orderGroupId], references: [id])
  invoice    Invoice?    @relation(fields: [invoiceId], references: [id])

  @@index([providerId, createdAt])
  @@index([orderId])
  @@index([orderGroupId])
  @@index([invoiceId])
}

model CommissionConfig {
  id                   String                 @id @default(cuid())
  scope                CommissionScope        @default(PLATFORM)
  providerId           String?
  categoryId           String?
  mode                 CommissionMode         @default(HYBRID)
  commissionRateBps    Int?
  minCommissionCents   Int                    @default(0)
  maxCommissionCents   Int?
  deliveryFeeRecipient FeeRecipient           @default(PLATFORM)
  gatewayFeeRecipient  FeeRecipient           @default(PLATFORM)
  discountRule         CommissionDiscountRule @default(AFTER_DISCOUNT)
  gatewayFeeRateBps    Int?
  gatewayFeeFlatCents  Int?
  payoutHoldDays       Int                    @default(0)
  minimumPayoutCents   Int                    @default(0)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt

  provider   Provider?         @relation(fields: [providerId], references: [id])
  category   Category?         @relation(fields: [categoryId], references: [id])
  financials OrderFinancials[]

  @@index([scope])
  @@index([providerId])
  @@index([categoryId])
  @@index([providerId, categoryId])
}

model OrderFinancials {
  id                   String                 @id @default(cuid())
  orderId              String                 @unique
  providerId           String
  commissionConfigId   String?
  currency             String                 @default("EGP")
  subtotalCents        Int
  deliveryFeeCents     Int                    @default(0)
  serviceFeeCents      Int                    @default(0)
  discountCents        Int                    @default(0)
  loyaltyDiscountCents Int                    @default(0)
  taxCents             Int                    @default(0)
  gatewayFeeCents      Int                    @default(0)
  commissionRateBps    Int                    @default(0)
  commissionCents      Int                    @default(0)
  vendorNetCents       Int                    @default(0)
  platformRevenueCents Int                    @default(0)
  deliveryFeeRecipient FeeRecipient           @default(PLATFORM)
  gatewayFeeRecipient  FeeRecipient           @default(PLATFORM)
  discountRule         CommissionDiscountRule @default(AFTER_DISCOUNT)
  holdUntil            DateTime?
  releasedAt           DateTime?
  settledAt            DateTime               @default(now())
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt

  order            Order             @relation(fields: [orderId], references: [id])
  provider         Provider          @relation(fields: [providerId], references: [id])
  commissionConfig CommissionConfig? @relation(fields: [commissionConfigId], references: [id])

  @@index([providerId, settledAt])
  @@index([orderId])
}

model VendorBalance {
  id                      String    @id @default(cuid())
  providerId              String    @unique
  currency                String    @default("EGP")
  availableCents          Int       @default(0)
  pendingCents            Int       @default(0)
  lifetimeSalesCents      Int       @default(0)
  lifetimeCommissionCents Int       @default(0)
  lifetimeEarningsCents   Int       @default(0)
  lastSettlementAt        DateTime?
  lastPayoutAt            DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  provider Provider @relation(fields: [providerId], references: [id])
}

model Payout {
  id            String       @id @default(cuid())
  providerId    String
  amountCents   Int
  feeCents      Int          @default(0)
  currency      String       @default("EGP")
  referenceId   String?
  status        PayoutStatus @default(PENDING)
  requestedById String?
  processedById String?
  processedAt   DateTime?
  failureReason String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  provider      Provider            @relation(fields: [providerId], references: [id])
  requestedBy   User?               @relation("PayoutRequestedBy", fields: [requestedById], references: [id])
  processedBy   User?               @relation("PayoutProcessedBy", fields: [processedById], references: [id])
  ledgerEntries TransactionLedger[]

  @@index([providerId, createdAt])
  @@index([status, createdAt])
}

model TransactionLedger {
  id          String          @id @default(cuid())
  providerId  String
  orderId     String?
  payoutId    String?
  type        LedgerEntryType
  amountCents Int
  currency    String          @default("EGP")
  metadata    Json?
  createdAt   DateTime        @default(now())

  provider Provider @relation(fields: [providerId], references: [id])
  order    Order?   @relation(fields: [orderId], references: [id])
  payout   Payout?  @relation(fields: [payoutId], references: [id])

  @@index([providerId, createdAt])
  @@index([orderId])
  @@index([payoutId])
}

model ProviderNotificationPreference {
  id          String   @id @default(cuid())
  providerId  String   @unique
  preferences Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  provider Provider @relation(fields: [providerId], references: [id])
}

model UserNotificationPreference {
  id          String   @id @default(cuid())
  userId      String   @unique
  preferences Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}
