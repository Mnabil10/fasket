generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ADMIN
  STAFF
}

enum ProductStatus {
  DRAFT
  ACTIVE
  HIDDEN
  DISCONTINUED
}

enum OrderStatus {
  PENDING
  PROCESSING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELED
}

enum PaymentMethod {
  COD
  CARD
}

enum LoyaltyTransactionType {
  EARN
  REDEEM
  ADJUST
}

enum AutomationEventStatus {
  PENDING
  SENT
  FAILED
  DEAD
}

enum TelegramLinkStatus {
  linked
  blocked
  unlinked
}

model User {
  id         String    @id @default(cuid())
  email      String?   @unique
  phone      String    @unique
  password   String
  role       UserRole  @default(CUSTOMER)
  name       String
  loyaltyPoints Int    @default(0)
  twoFaEnabled Boolean @default(false)
  twoFaSecret  String?
  addresses  Address[]
  cart       Cart?
  orders     Order[]
  loyaltyTransactions LoyaltyTransaction[]
  loyaltyCycles LoyaltyCycle[]
  sessions   SessionLog[]
  pushDevices PushDevice[]
  telegramLink TelegramLink?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Address {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  zoneId     String
  label      String?
  city       String?
  street     String?
  building   String?
  apartment  String?
  notes      String?
  lat        Float?
  lng        Float?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  orders     Order[]

  @@index([zoneId])
}

model Category {
  id        String     @id @default(cuid())
  name      String
  nameAr    String?
  slug      String     @unique
  imageUrl  String?
  isActive  Boolean    @default(true)
  sortOrder Int        @default(0)
  products  Product[]
  parentId  String?
  parent    Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryToCategory")
  deletedAt DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([parentId])
  @@index([isActive, sortOrder])
}

model Product {
  id             String        @id @default(cuid())
  categoryId     String?
  category       Category?     @relation(fields: [categoryId], references: [id])
  sku            String?       @unique
  name           String
  nameAr         String?
  slug           String        @unique
  description    String?
  descriptionAr  String?
  imageUrl       String?
  priceCents     Int
  costPriceCents Int?          @default(0)
  salePriceCents Int?
  stock          Int           @default(0)
  status         ProductStatus @default(ACTIVE)
  isHotOffer     Boolean       @default(false)
  images         String[]
  cartItems      CartItem[]
  orderItems     OrderItem[]
  stockLogs      ProductStockLog[]
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([name])
  @@index([slug])
  @@index([categoryId, status])
  @@index([isHotOffer, status, createdAt])
  @@index([status, createdAt])
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
  orders    Order[]
  couponCode String?
  updatedAt DateTime   @updatedAt
  createdAt DateTime   @default(now())
}

model CartItem {
  id         String @id @default(cuid())
  cartId     String
  productId  String
  qty        Int    @default(1)
  priceCents Int

  cart    Cart    @relation(fields: [cartId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
}

model Order {
  id               String               @id @default(cuid())
  code             String               @default(cuid()) @unique
  userId           String
  user             User                 @relation(fields: [userId], references: [id])
  idempotencyKey   String?
  cartId           String?
  cart             Cart?                @relation(fields: [cartId], references: [id])
  addressId        String?
  address          Address?             @relation(fields: [addressId], references: [id])
  deliveryZoneId   String?
  deliveryZoneName String?
  deliveryEtaMinutes Int?
  estimatedDeliveryTime String?
  notes            String?
  couponCode       String?
  subtotalCents    Int
  shippingFeeCents Int                  @default(0)
  discountCents    Int                  @default(0)
  loyaltyDiscountCents Int              @default(0)
  loyaltyPointsUsed   Int               @default(0)
  loyaltyPointsEarned Int               @default(0)
  totalCents       Int
  status           OrderStatus          @default(PENDING)
  paymentMethod    PaymentMethod        @default(COD)
  driverId         String?
  driver           DeliveryDriver?      @relation(fields: [driverId], references: [id], onDelete: SetNull)
  driverAssignedAt DateTime?
  items            OrderItem[]
  statusHistory    OrderStatusHistory[]
  loyaltyTransactions LoyaltyTransaction[]
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@index([status, createdAt])
  @@index([userId, createdAt])
  @@index([driverId])
  @@index([driverId, createdAt])
  @@unique([userId, idempotencyKey])
  @@index([code])
  @@index([createdAt])
}

model OrderItem {
  id                  String @id @default(cuid())
  orderId             String
  productId           String
  productNameSnapshot String
  priceSnapshotCents  Int
  unitPriceCents      Int    @default(0)
  unitCostCents       Int    @default(0)
  lineTotalCents      Int    @default(0)
  lineProfitCents     Int    @default(0)
  qty                 Int

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([orderId])
}

model SupportQueryAudit {
  id            String   @id @default(cuid())
  endpoint      String
  phoneHash     String?
  phoneMasked   String?
  orderCode     String?
  success       Boolean  @default(false)
  correlationId String?
  ip            String?
  responseSnippet String?
  createdAt     DateTime @default(now())

  @@index([endpoint, createdAt])
}

model OrderStatusHistory {
  id        String       @id @default(cuid())
  orderId   String
  order     Order        @relation(fields: [orderId], references: [id])
  from      OrderStatus?
  to        OrderStatus
  note      String?
  actorId   String?
  createdAt DateTime     @default(now())
}

model DeliveryDriver {
  id                  String   @id @default(cuid())
  fullName            String
  phone               String   @unique
  nationalId          String   @unique
  nationalIdImageUrl  String?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  vehicle             DeliveryVehicle?
  orders              Order[]

  @@index([isActive, createdAt])
  @@index([isActive])
  @@index([fullName])
  @@index([phone])
  @@index([nationalId])
  @@index([createdAt])
}

model DeliveryVehicle {
  id              String   @id @default(cuid())
  driverId        String   @unique
  driver          DeliveryDriver @relation(fields: [driverId], references: [id])
  type            String
  plateNumber     String   @unique
  licenseImageUrl String?
  color           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([plateNumber])
}

model DeliveryZone {
  id                         String   @id @default(cuid())
  nameEn                     String
  nameAr                     String?
  city                       String?
  region                     String?
  feeCents                   Int
  etaMinutes                 Int?
  freeDeliveryThresholdCents Int?
  minOrderAmountCents        Int?
  isActive                   Boolean  @default(true)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@index([isActive, nameEn])
  @@index([city])
  @@index([region])
  @@index([isActive, city, region])
}

model LoyaltyCycle {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  threshold       Int
  resetOnComplete Boolean  @default(true)
  earnedInCycle   Int      @default(0)
  transactions    LoyaltyTransaction[]

  @@index([userId, completedAt])
}

model LoyaltyTransaction {
  id        String                  @id @default(cuid())
  userId    String
  user      User                    @relation(fields: [userId], references: [id])
  orderId   String?
  order     Order?                  @relation(fields: [orderId], references: [id])
  type      LoyaltyTransactionType
  points    Int
  metadata  Json?
  cycleId   String?
  cycle     LoyaltyCycle?           @relation(fields: [cycleId], references: [id])
  createdAt DateTime                @default(now())

  @@index([userId, createdAt])
  @@index([orderId])
  @@index([cycleId])
  @@index([userId, type, createdAt])
}

model NotificationTemplate {
  id        String   @id @default(cuid())
  key       String
  language  String   @db.VarChar(8)
  title     String?
  body      String
  channel   String   @default("push")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, language, channel])
}

model ProductStockLog {
  id           String   @id @default(cuid())
  productId    String
  product      Product  @relation(fields: [productId], references: [id])
  previousStock Int
  newStock     Int
  delta        Int
  reason       String
  actorId      String?
  createdAt    DateTime @default(now())

  @@index([productId, createdAt])
}

model AuditLog {
  id            String   @id @default(cuid())
  actorId       String?
  action        String
  entity        String
  entityId      String?
  before        Json?
  after         Json?
  ip            String?
  userAgent     String?
  correlationId String?
  createdAt     DateTime @default(now())

  @@index([entity, entityId])
  @@index([actorId, createdAt])
}

model SessionLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  ip        String?
  userAgent String?
  device    Json?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model AutomationEvent {
  id             String                @id @default(uuid())
  type           String
  payload        Json
  status         AutomationEventStatus @default(PENDING)
  attempts       Int                   @default(0)
  nextAttemptAt  DateTime?
  dedupeKey      String?
  correlationId  String?
  lastHttpStatus Int?
  lastError      String?
  lastResponseAt DateTime?
  lastResponseBodySnippet String?
  sentAt         DateTime?
  createdAt      DateTime              @default(now())

  @@index([status, nextAttemptAt])
  @@index([dedupeKey])
  @@index([type])
  @@index([createdAt])
  @@unique([type, dedupeKey])
}

// prisma/schema.prisma  (only the Setting model shown)
model Setting {
  id        String   @id @default(cuid())

  // General
  storeName        String   @default("Fasket")
  storeNameAr      String?
  storeDescription String?  // long text
  storeDescriptionAr String?
  contactEmail     String?  // e.g. support@fasket.com
  contactPhone     String?
  storeAddress     String?
  businessHours    Json?    // { monday:{open,close,enabled}, ... }

  // Delivery
  deliveryFeeCents         Int     @default(0)  // e.g. 499 for 4.99
  freeDeliveryMinimumCents Int     @default(0)
  estimatedDeliveryTime    String? // "25-30 minutes"
  maxDeliveryRadiusKm      Int?    // 10
  deliveryZones            Json?   // [{name, fee, enabled}, ...]

  // Payment (JSON for flexibility)
  payment                  Json?   // { cashOnDelivery, creditCards, digitalWallets, stripe }

  // Notifications
  notifications            Json?   // { orderNotifications, marketingEmails, adminAlerts }

  // Loyalty
  loyaltyEnabled           Boolean @default(false)
  loyaltyEarnPoints        Int     @default(1)     // points granted per earn unit
  loyaltyEarnPerCents      Int     @default(100)   // cents needed to earn loyaltyEarnPoints
  loyaltyRedeemRate        Int     @default(100)   // points required per redeem unit
  loyaltyRedeemUnitCents   Int     @default(100)   // value in cents of one redeem unit
  loyaltyMinRedeemPoints   Int     @default(0)
  loyaltyMaxDiscountPercent Int    @default(100)
  loyaltyMaxRedeemPerOrder Int     @default(0)
  loyaltyResetThreshold    Int     @default(0)
  loyaltyEarnRate          Float?
  loyaltyRedeemRateValue   Float?

  // System
  maintenanceMode          Boolean @default(false)
  allowRegistrations       Boolean @default(true)
  requireEmailVerification Boolean @default(true)
  sessionTimeoutMinutes    Int     @default(30)
  maxLoginAttempts         Int     @default(5)
  dataRetentionDays        Int     @default(365)
  backupFrequency          String  @default("daily") // daily|weekly|monthly
  timezone                 String  @default("America/New_York")
  language                 String  @default("en")
  currency                 String  @default("EGP")

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model TelegramLink {
  id                Int                @id @default(autoincrement()) @map("id")
  userId            String             @unique @map("user_id")
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  phoneE164         String             @unique @map("phone_e164")
  telegramChatId    BigInt             @unique @map("telegram_chat_id")
  telegramUserId    BigInt?            @map("telegram_user_id")
  telegramUsername  String?            @map("telegram_username")
  status            TelegramLinkStatus @default(linked)
  linkedAt          DateTime?          @map("linked_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  createdAt         DateTime           @default(now()) @map("created_at")
  lastOtpSentAt     DateTime?          @map("last_otp_sent_at")
  lastOtpAttempts   Int                @default(0) @map("last_otp_attempts")

  @@index([status])
  @@index([lastOtpSentAt])
  @@map("telegram_links")
}

model SignupLink {
  sessionKey       String   @id @map("session_key")
  telegramChatId   BigInt   @map("telegram_chat_id")
  telegramUserId   BigInt?  @map("telegram_user_id")
  telegramUsername String?  @map("telegram_username")
  createdAt        DateTime @default(now()) @map("created_at")
  expiresAt        DateTime @map("expires_at")
  otpHash          String?  @map("otp_hash")
  otpExpiresAt     DateTime? @map("otp_expires_at")
  otpAttempts      Int      @default(0) @map("otp_attempts")
  requestId        String?  @map("request_id")

  @@index([expiresAt])
  @@map("signup_links")
}

model SignupSession {
  id               String   @id @map("id")
  phone            String   @map("phone")
  country          String   @map("country")
  fullName         String?  @map("full_name")
  status           String   @default("PENDING_TELEGRAM") @map("status")
  telegramChatId   BigInt?  @map("telegram_chat_id")
  telegramUserId   BigInt?  @map("telegram_user_id")
  telegramUsername String?  @map("telegram_username")
  otpHash          String?  @map("otp_hash")
  otpExpiresAt     DateTime? @map("otp_expires_at")
  otpAttempts      Int      @default(0) @map("otp_attempts")
  requestId        String?  @map("request_id")
  createdAt        DateTime @default(now()) @map("created_at")
  expiresAt        DateTime @map("expires_at")

  @@index([status])
  @@index([expiresAt])
  @@map("signup_sessions")
}

enum CouponType {
  PERCENT
  FIXED
}

model Coupon {
  id              String     @id @default(cuid())
  code            String     @unique
  type            CouponType
  valueCents      Int        // For FIXED: amount in cents; For PERCENT: percentage value (0-100)
  isPercent       Boolean    @default(false) // legacy helper, not required
  isActive        Boolean    @default(true)
  startsAt        DateTime?
  endsAt          DateTime?
  minOrderCents   Int?
  maxDiscountCents Int?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model PushDevice {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String   @default("unknown")
  language  String?  @db.VarChar(8)
  appVersion String?
  deviceModel String?
  lastActiveAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
