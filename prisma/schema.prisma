generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  ADMIN
  STAFF
}

enum ProductStatus {
  DRAFT
  ACTIVE
  HIDDEN
  DISCONTINUED
}

enum OrderStatus {
  PENDING
  PROCESSING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELED
}

enum PaymentMethod {
  COD
  CARD
}

model User {
  id        String    @id @default(cuid())
  email     String?   @unique
  phone     String    @unique
  password  String
  role      UserRole  @default(CUSTOMER)
  name      String
  addresses Address[]
  cart      Cart?
  orders    Order[]
  sessions  SessionLog[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  pushDevices  PushDevice[]
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  label     String
  city      String
  zone      String?
  street    String
  building  String?
  apartment String?
  lat       Float?
  lng       Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Order     Order[]
}

model Category {
  id        String     @id @default(cuid())
  name      String
  nameAr    String?
  slug      String     @unique
  imageUrl  String?
  isActive  Boolean    @default(true)
  sortOrder Int        @default(0)
  products  Product[]
  parentId  String?
  parent    Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryToCategory")
  deletedAt DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([parentId])
  @@index([isActive, sortOrder])
}

model Product {
  id             String        @id @default(cuid())
  categoryId     String?
  category       Category?     @relation(fields: [categoryId], references: [id])
  sku            String?       @unique
  name           String
  nameAr         String?
  slug           String        @unique
  description    String?
  descriptionAr  String?
  imageUrl       String?
  priceCents     Int
  salePriceCents Int?
  stock          Int           @default(0)
  status         ProductStatus @default(ACTIVE)
  isHotOffer     Boolean       @default(false)
  images         String[]
  cartItems      CartItem[]
  orderItems     OrderItem[]
  stockLogs      ProductStockLog[]
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([name])
  @@index([slug])
  @@index([categoryId, status])
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
  orders    Order[]
  updatedAt DateTime   @updatedAt
  createdAt DateTime   @default(now())
}

model CartItem {
  id         String @id @default(cuid())
  cartId     String
  productId  String
  qty        Int    @default(1)
  priceCents Int

  cart    Cart    @relation(fields: [cartId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
}

model Order {
  id               String               @id @default(cuid())
  userId           String
  user             User                 @relation(fields: [userId], references: [id])
  cartId           String?
  cart             Cart?                @relation(fields: [cartId], references: [id])
  addressId        String?
  address          Address?             @relation(fields: [addressId], references: [id])
  notes            String?
  couponCode       String?
  subtotalCents    Int
  shippingFeeCents Int                  @default(0)
  discountCents    Int                  @default(0)
  totalCents       Int
  status           OrderStatus          @default(PENDING)
  paymentMethod    PaymentMethod        @default(COD)
  items            OrderItem[]
  statusHistory    OrderStatusHistory[]
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@index([status, createdAt])
  @@index([userId, createdAt])
}

model OrderItem {
  id                  String @id @default(cuid())
  orderId             String
  productId           String
  productNameSnapshot String
  priceSnapshotCents  Int
  qty                 Int

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model OrderStatusHistory {
  id        String       @id @default(cuid())
  orderId   String
  order     Order        @relation(fields: [orderId], references: [id])
  from      OrderStatus?
  to        OrderStatus
  note      String?
  actorId   String?
  createdAt DateTime     @default(now())
}

model ProductStockLog {
  id           String   @id @default(cuid())
  productId    String
  product      Product  @relation(fields: [productId], references: [id])
  previousStock Int
  newStock     Int
  delta        Int
  reason       String
  actorId      String?
  createdAt    DateTime @default(now())

  @@index([productId, createdAt])
}

model AuditLog {
  id            String   @id @default(cuid())
  actorId       String?
  action        String
  entity        String
  entityId      String?
  before        Json?
  after         Json?
  ip            String?
  userAgent     String?
  correlationId String?
  createdAt     DateTime @default(now())

  @@index([entity, entityId])
  @@index([actorId, createdAt])
}

model SessionLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  ip        String?
  userAgent String?
  device    Json?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

// prisma/schema.prisma  (only the Setting model shown)
model Setting {
  id        String   @id @default(cuid())

  // General
  storeName        String   @default("Fasket")
  storeNameAr      String?
  storeDescription String?  // long text
  storeDescriptionAr String?
  contactEmail     String?  // e.g. support@fasket.com
  contactPhone     String?
  storeAddress     String?
  businessHours    Json?    // { monday:{open,close,enabled}, ... }

  // Delivery
  deliveryFeeCents         Int     @default(0)  // e.g. 499 for 4.99
  freeDeliveryMinimumCents Int     @default(0)
  estimatedDeliveryTime    String? // "25-30 minutes"
  maxDeliveryRadiusKm      Int?    // 10
  deliveryZones            Json?   // [{name, fee, enabled}, ...]

  // Payment (JSON for flexibility)
  payment                  Json?   // { cashOnDelivery, creditCards, digitalWallets, stripe }

  // Notifications
  notifications            Json?   // { orderNotifications, marketingEmails, adminAlerts }

  // System
  maintenanceMode          Boolean @default(false)
  allowRegistrations       Boolean @default(true)
  requireEmailVerification Boolean @default(true)
  sessionTimeoutMinutes    Int     @default(30)
  maxLoginAttempts         Int     @default(5)
  dataRetentionDays        Int     @default(365)
  backupFrequency          String  @default("daily") // daily|weekly|monthly
  timezone                 String  @default("America/New_York")
  language                 String  @default("en")
  currency                 String  @default("EGP")

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

enum CouponType {
  PERCENT
  FIXED
}

model Coupon {
  id              String     @id @default(cuid())
  code            String     @unique
  type            CouponType
  valueCents      Int        // For FIXED: amount in cents; For PERCENT: percentage value (0-100)
  isPercent       Boolean    @default(false) // legacy helper, not required
  isActive        Boolean    @default(true)
  startsAt        DateTime?
  endsAt          DateTime?
  minOrderCents   Int?
  maxDiscountCents Int?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model PushDevice {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String   @default("unknown")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
